{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "1225841631857983226"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for deployed resources. If empty, uses the resource group location."
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "adslibrary",
      "metadata": {
        "description": "Short name used as a prefix for Azure resources. Keep it globally unique where required."
      }
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "defaultValue": "[format('{0}-cae', parameters('appName'))]",
      "metadata": {
        "description": "Name of the Container Apps managed environment."
      }
    },
    "containerAppName": {
      "type": "string",
      "defaultValue": "[format('{0}-ca', parameters('appName'))]",
      "metadata": {
        "description": "Name of the Container App."
      }
    },
    "containerImage": {
      "type": "string",
      "metadata": {
        "description": "Container image to deploy to Azure Container Apps (e.g., docker.io/5he11/adslibrary:sha-<commit>)."
      }
    },
    "scrapecreatorsApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "ScrapeCreators API key passed to the container as SCRAPECREATORS_API_KEY."
      }
    },
    "customDomain": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Custom domain name to bind to the Container App (host name). Leave empty to skip binding."
      }
    },
    "ingressTargetPort": {
      "type": "int",
      "defaultValue": 80,
      "metadata": {
        "description": "The external ingress target port for the container."
      }
    }
  },
  "variables": {
    "logAnalyticsName": "[format('{0}-law', parameters('appName'))]",
    "environmentName": "[parameters('containerAppsEnvironmentName')]",
    "containerAppResourceName": "[parameters('containerAppName')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logAnalytics",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17148665012667003023"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the workspace."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "customerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2023-09-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "managedEnvironment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('environmentName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalytics'), '2025-04-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "6610912289930016330"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps managed environment."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the managed environment."
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resourceId of the Log Analytics workspace."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2023-09-01').value[0].customerId]",
                    "sharedKey": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2023-09-01').value[0].primarySharedKey]"
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalytics')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerApp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('containerAppResourceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "managedEnvironmentId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'managedEnvironment'), '2025-04-01').outputs.id.value]"
          },
          "containerImage": {
            "value": "[parameters('containerImage')]"
          },
          "ingressTargetPort": {
            "value": "[parameters('ingressTargetPort')]"
          },
          "scrapecreatorsApiKey": {
            "value": "[parameters('scrapecreatorsApiKey')]"
          },
          "customDomain": {
            "value": "[parameters('customDomain')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17451190475951306063"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location of the Container App."
              }
            },
            "managedEnvironmentId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the managed environment."
              }
            },
            "containerImage": {
              "type": "string",
              "metadata": {
                "description": "Container image to deploy (e.g., docker.io/5he11/adslibrary:sha-<commit>)."
              }
            },
            "ingressTargetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "The external ingress target port for the container."
              }
            },
            "scrapecreatorsApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "ScrapeCreators API key passed to the container as SCRAPECREATORS_API_KEY."
              }
            },
            "customDomain": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Custom domain name to bind to the Container App (host name). Leave empty to skip binding."
              }
            },
            "customDomainBindingName": {
              "type": "string",
              "defaultValue": "[parameters('customDomain')]",
              "metadata": {
                "description": "Custom domain certificate binding name. Defaults to the hostname."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "managedEnvironmentId": "[parameters('managedEnvironmentId')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('ingressTargetPort')]",
                    "transport": "auto"
                  },
                  "secrets": [
                    {
                      "name": "scrapecreators-api-key",
                      "value": "[parameters('scrapecreatorsApiKey')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "app",
                      "image": "[parameters('containerImage')]",
                      "env": [
                        {
                          "name": "SCRAPECREATORS_API_KEY",
                          "secretRef": "scrapecreators-api-key"
                        }
                      ],
                      "resources": {
                        "cpu": "0.25",
                        "memory": "0.5Gi"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 1
                  }
                }
              }
            },
            {
              "condition": "[not(empty(parameters('customDomain')))]",
              "type": "Microsoft.App/containerApps/customDomains",
              "apiVersion": "2024-03-01",
              "name": "[format('{0}/{1}', parameters('name'), parameters('customDomainBindingName'))]",
              "properties": {
                "name": "[parameters('customDomain')]",
                "bindingType": "SniEnabled",
                "certificateBindingType": "ManagedCertificate"
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "customDomainName": {
              "type": "string",
              "metadata": {
                "description": "The custom domain name requested for binding."
              },
              "value": "[parameters('customDomain')]"
            },
            "customDomainValidationHelp": {
              "type": "object",
              "metadata": {
                "description": "Guidance for external DNS validation when using managed certificates."
              },
              "value": "[if(not(empty(parameters('customDomain'))), createObject('guidance', 'Create required DNS validation records in your external DNS provider (e.g., Cloudflare), then re-run deployment.', 'records', createObject('cname', createObject('name', parameters('customDomain'), 'type', 'CNAME', 'value', reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn))), createObject('guidance', 'No custom domain provided.'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'managedEnvironment')]"
      ]
    }
  ],
  "outputs": {
    "containerAppId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerApp'), '2025-04-01').outputs.id.value]"
    },
    "containerAppFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerApp'), '2025-04-01').outputs.fqdn.value]"
    }
  }
}